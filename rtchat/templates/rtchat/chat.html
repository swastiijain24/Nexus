{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto my-10 px-6">
    <div id="chat_window"
        class="h-[45rem] flex flex-col bg-zinc-900 rounded-2xl border border-zinc-800 shadow-2xl relative overflow-hidden">
        {% if other_user %}

        <div class="flex items-end gap-2 max-w-[75%]">
            <a href="/profile/{{ other_user.username }}/" class="flex-shrink-0">
                <img class="w-8 h-8 rounded-full object-cover ring-2 ring-zinc-700"
                    src="{{ other_user.profile.profileimg.url }}" alt="Avatar">
            </a>
        </div>
        <div class="text-sm font-light py-1 ml-10">
            <span class="text-white font-medium">{{ other_user.profile.name }}</span>
            <span class="text-zinc-500">@{{ other_user.username }}</span>
        </div>

        {% elif chat_group.groupchat_name %}
        <!-- Group chat header with members -->
        <div class="bg-zinc-900 p-3 border-b border-zinc-800 rounded-t-2xl flex-shrink-0">
            <div class="text-center mb-2">
                <span class="text-white font-semibold">{{ chat_group.groupchat_name }}</span>
            </div>
            <div>
                {% if user == chat_group.admin %}
                <a href="{% url 'edit_group' chat_group.groupname %}">edit </a>
                {% endif %}
            </div>
            <ul id="groupchat-members" class="flex justify-center gap-3 overflow-x-auto">
                {% for member in chat_group.group_members.all %}
                <li>
                    <a href="/profile/{{ member.username }}/"
                        class="flex flex-col items-center gap-1 text-zinc-400 hover:text-white transition-colors">
                        <img src="{{ member.profile.profileimg.url }}"
                            class="w-10 h-10 rounded-full object-cover ring-2 ring-zinc-700" />
                        <span class="text-xs truncate max-w-[60px]">{{member.profile.name|default:member.username|slice:":8" }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {%else%}
        <!-- Online count header -->
        <div
            class="flex justify-center items-center gap-2 text-emerald-400 bg-zinc-900 p-3 border-b border-zinc-800 rounded-t-2xl flex-shrink-0">
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
            <span id="online-count"></span> online
        </div>
        {%endif%}

        <!-- Chat messages container -->
        <div id='chat_container' class="overflow-y-auto flex-1 p-4 min-h-0">
            <ul id='chat_messages' class="flex flex-col gap-4 overflow-x-hidden">
                {% for message in chat_messages reversed %}
                {% include 'rtchat/chat_message.html' %}
                {% endfor %}
            </ul>
        </div>

        <!-- Message input -->
        <div class="p-4 border-t border-zinc-800 flex-shrink-0">
            <form id="chat_message_form" class="flex items-center gap-3" hx-ext="ws"
                ws-connect="/ws/chatroom/{{chatroom_name}}" ws-send
                _="on htmx:wsAfterSend reset() me then call scrollToBottom()">
                {% csrf_token %}
                {{ form.body }}
                <button type="submit"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex-shrink-0 transition-colors">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Auto-scroll function
    function scrollToBottom() {
        const container = document.getElementById('chat_container');
        container.scrollTop = container.scrollHeight;
    }

    // Scroll on page load
    document.addEventListener('DOMContentLoaded', function () {
        scrollToBottom();

        // Watch for new messages being added to the chat
        const chatMessages = document.getElementById('chat_messages');
        const observer = new MutationObserver(function (mutations) {
            scrollToBottom();
        });

        observer.observe(chatMessages, { childList: true, subtree: true });
    });
</script>
{% endblock %}